---
type: lesson
title: A basic CSRF vulnerability
focus: /app/api/serve-picture/route.ts
slug: basic-csrf
# @see https://github.com/stackblitz/tutorialkit/issues/327
# rss: true
# publishedAt: 2024-09-10
---

# A basic CSRF vulnerability

## Forcing a user to send a request

The core idea of Cross-Site Request Forgery, aka CSRF,
is to force a user into sending an authenticated request to a certain URL.

For instance, the attacker may want to force the victim
into sending a request to `api/transfer-money-to?account="attackerId"`.

In this demo, the attacker misuses a forum system and posts an image
which URL is not an actual image, but the URL of the money transfer API.

When this "image" is displayed to the victim, 
they get their account stolen.

## How to fix

In this very simple demo, we can move the GET endpoint to a POST endpoint.

But that's not enough for more elaborate attacks. 

Usually, a CSRF attack is led by using a second pirate website,
and somehow having it to fire an authenticated request to your website when the victims connects to it.
This is what "cross-site" means.

A solution is to use a specific token that is only ever available on your own website,
so you can tell that the request comes from your application and not an attacker website.

There are other complementary mechanisms to prevent CSRF attacks, you'll find more information in the resources section below.

## ðŸ”¨ Practice: add a CSRF token

- First, move the GET endpoint to a POST endpoint

This is not enough to prevent more elaborate cross-site request forgery 
where an attacker forces the submission of a form with the POST method.

- Generate a CSRF token in a middleware,
and store it into a Same-Site cookie

- Check this token in the API endpoint

## References

[OWASP Top 10](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)

[Understanding CSRF attacks, Vercel](https://vercel.com/blog/understanding-csrf-attacks)

[Edge CSRF, for generating CSRF tokens in edge middlewares](https://github.com/kubetail-org/edge-csrf)

[Securing Server-Rendered Applications â€“ Next.js Case](https://gitnation.com/contents/securing-server-rendered-applications-nextjs-case)

import BetaBanner from "@/components/BetaBanner.mdx"

<BetaBanner />

import ReactAdvancedBanner from "@/components/ReactAdvancedBanner.mdx"

<ReactAdvancedBanner />